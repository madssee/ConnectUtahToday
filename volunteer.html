<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Volunteering</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .filter-section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 2em auto 1.5em auto;
      padding: 2em 1.5em;
    }
    .opportunity-list {
      max-width: 700px;
      margin: 0 auto 3em auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.11);
      padding: 2em 1.5em;
    }
    .opportunity-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.5em;
      border-bottom: 1px solid #eee;
      padding-bottom: 1.2em;
    }
    .opportunity-item:last-child {
      border-bottom: none;
    }
    .opportunity-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 1.2em;
      background: #eee;
    }
    .opportunity-org {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: .2em;
    }
    .opportunity-activities {
      margin: .25em 0 0 1.2em;
      padding: 0;
      list-style: circle;
    }
    .no-opps-msg {
      text-align: center;
      color: #555;
      margin: 2em 0 1em 0;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="calendar.html">Calendar</a> |
    <a href="events.html">Events</a> |
    <a href="volunteer.html">Volunteering</a> |
    <a href="support.html">Support a Cause</a> |
    <a href="latest-updates.html">Latest Updates</a> |
    <a href="activism.html">Activism</a>
  </nav>
  <main>
    <h1>Volunteer for Local Events and Organizations</h1>
    <p style="font-size:0.97em;">
      Be matched with volunteer opportunities with local organizations by selecting the boxes of interest to you below.
      <a href="#" id="disclaimer-link" style="font-size:0.92em;text-decoration:underline;cursor:pointer;">Disclaimer</a>
    </p>
    <section class="filter-section">
      <form id="volunteer-filter-form">
        <fieldset style="margin-bottom:1.5em;">
          <legend><strong>Organization:</strong></legend>
          <div id="org-dropdowns">
            <!-- Org dropdown inputs will be inserted here -->
          </div>
          <button type="button" id="add-org-dropdown" style="margin-top:0.8em;">+ Add another organization</button>
        </fieldset>
        <fieldset style="margin-bottom:1.5em;">
          <legend><strong>Activities:</strong></legend>
          <div id="activity-checkboxes">
            <span style="color:#888;">Loading activities...</span>
          </div>
        </fieldset>
      </form>
    </section>
    <section class="opportunity-list" id="opportunity-list">
      <div style="color:#888;">Loading opportunities...</div>
    </section>
  </main>
  <div id="disclaimer-popover" style="display:none;position:fixed;top:22%;left:50%;transform:translate(-50%,0);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:520px;z-index:1000;border-radius:8px;font-size:0.97em;">
    <strong>Disclaimer:</strong> Connect Utah Today provides links to external organizations offering volunteer opportunities for informational purposes only. We do not endorse, guarantee, or assume responsibility for the organizations listed or the opportunities they provide. All volunteering arrangements are made directly between you and the respective organization. Connect Utah Today does not verify the legitimacy, safety, or quality of any volunteer opportunity or organization, and is not responsible for any outcomes, experiences, or issues arising from your participation. Please conduct your own due diligence before engaging with any organization. By clicking on a volunteer opportunity link, you will be redirected to a third-party website and subject to their terms, conditions, and privacy policies. Connect Utah Today is not responsible for the content or practices of any linked site.
    <br><br>
    <button id="close-disclaimer" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
  </div>
  <script>
    // ---- Utility: Org Name to Asset Normalization ----
    function normalize(name) {
      return name
        .toLowerCase()
        .replace(/[\s\-]+/g, '_')
        .replace(/[^a-z0-9_]/g, '')
        .replace(/_+/g, '_')
        .replace(/^_+|_+$/g, '');
    }

    const assetFiles = [
      '1000014843.png',
      '1000014844.png',
      '1000014845.png',
      '1000014846.png',
      '1000014847.png',
      '1000014848.png',
      'Armed Queers Salt Lake City.jpg',
      'bakers_for_palestine.jpg',
      'bakers_for_palestine.png',
      'brown_berets.png',
      'BTMC.jpg',
      'Cache Valley Mutual Aid.jpg',
      'Camping in Color SLC.jpg',
      'Comunidades Unidas.jpg',
      'CUT.png',
      'description.png',
      'dsa.jpg',
      'dsa.png',
      'Fish For Garbage.jpg',
      'Green Wave Utah.jpg',
      'ibikeutah.jpg',
      'indivisible.png',
      'Ken_Sanders_Rare_Books.jpg',
      'MyUEA.jpg',
      'placeholder.jpg',
      'Project Rainbow.jpg',
      'Salt Lake Area Queer Climbers.jpg',
      'Salt Lake Harm Reduction Project.jpg',
      'Sierra Club Utah.jpg',
      'SLC Queer Latin Dance.jpg',
      'SLCounty Community Exchange.jpg',
      'slc_mutual_aid.png',
      'uhwunited.jpg',
      'Under the Umbrella Bookstore.jpg',
      'United_Mountain_Workers.jpg',
      'Urban Indian Center of Salt Lake.jpg',
      'Utah Rivers Council.jpg',
      'Utah State Progressive Caucus.jpg',
      'Wasatch Community Gardens.jpg',
      'Wasatch Food Co-op.jpg',
      'Wasatch Trails Collective.jpg',
      'WildUtah.png',
    ];

    function getOrgImg(orgName) {
      const nOrg = normalize(orgName);
      const assetMap = {};
      assetFiles.forEach(f => {
        let stem = f.replace(/\.[^/.]+$/, '');
        assetMap[normalize(stem)] = f;
      });
      if (assetMap[nOrg]) {
        return `assets/${assetMap[nOrg]}`;
      }
      for (let [nAsset, fname] of Object.entries(assetMap)) {
        if (nOrg.includes(nAsset) || nAsset.includes(nOrg)) {
          return `assets/${fname}`;
        }
      }
      return 'assets/placeholder.png';
    }

    let allOrganizations = [];
    let allOpportunities = [];
    let allActivities = [];

    // --- ADD THESE FUNCTIONS ---
    async function fetchOrganizations() {
      const res = await fetch('https://connectutahtoday-1.onrender.com/api/organizations');
      const data = await res.json();
      (data.organizations || []).forEach(org => {
        console.log('Organization link:', org.link);
      });
      return (data.organizations || []).map(org => ({
        id: org.id,
        name: org.name,
        link: org.link
      }));
    }

    async function fetchAllOpportunities() {
      const orgs = await fetchOrganizations();
      const allOpps = [];
      for (let org of orgs) {
        const res = await fetch(`https://connectutahtoday-1.onrender.com/api/opportunities?organization_id=${org.id}`);
        const data = await res.json();
        (data.opportunities || []).forEach(opp => {
          allOpps.push({
            orgId: org.id,
            orgName: org.name,
            orgLink: org.link,
            activity: opp
          });
        });
      }
      return allOpps;
    }

    // --- DROPDOWN AUTOCOMPLETE LOGIC ---
    function createOrgDropdown(index = 0) {
      // Create a text input with datalist for autocomplete
      const wrapper = document.createElement('div');
      wrapper.className = "org-dropdown-wrapper";
      wrapper.style.marginBottom = "0.6em";
      wrapper.innerHTML = `
        <input type="text" class="org-dropdown-input" list="org-list" placeholder="Type or select an organization" autocomplete="off" data-index="${index}" style="min-width:220px;padding:0.4em;">
        <button type="button" class="remove-org-dropdown" style="margin-left:0.6em;display:none;">Remove</button>
      `;
      return wrapper;
    }

    function renderOrgDropdowns(orgs) {
      const orgDropdownsDiv = document.getElementById('org-dropdowns');
      orgDropdownsDiv.innerHTML = '';
      // Datalist for autofill
      let datalist = document.getElementById('org-list');
      if (!datalist) {
        datalist = document.createElement('datalist');
        datalist.id = "org-list";
        document.body.appendChild(datalist);
      }
      datalist.innerHTML = orgs.map(org =>
        `<option value="${org.name}"></option>`
      ).join('');
      // Place one dropdown initially
      orgDropdownsDiv.appendChild(createOrgDropdown(0));
    }

    // --- Dynamic addition/removal of dropdowns ---
    function setupOrgDropdownLogic() {
      const orgDropdownsDiv = document.getElementById('org-dropdowns');
      const addBtn = document.getElementById('add-org-dropdown');

      addBtn.addEventListener('click', () => {
        const dropdowns = orgDropdownsDiv.querySelectorAll('.org-dropdown-wrapper');
        const newDropdown = createOrgDropdown(dropdowns.length);
        newDropdown.querySelector('.remove-org-dropdown').style.display = 'inline-block';
        orgDropdownsDiv.appendChild(newDropdown);
      });

      orgDropdownsDiv.addEventListener('click', (e) => {
        if (e.target.classList.contains('remove-org-dropdown')) {
          e.target.parentElement.remove();
          filterOpportunities();
        }
      });

      orgDropdownsDiv.addEventListener('input', (e) => {
        if (e.target.classList.contains('org-dropdown-input')) {
          filterOpportunities();
        }
      });
    }

    function getSelectedOrgs() {
      const orgDropdownsDiv = document.getElementById('org-dropdowns');
      const inputs = orgDropdownsDiv.querySelectorAll('.org-dropdown-input');
      let selected = [];
      inputs.forEach(input => {
        if (input.value.trim() !== "") selected.push(input.value.trim());
      });
      return selected.length ? selected : ["Any"];
    }

    // --- Activity checkbox logic ---
    function renderActivityCheckboxes(activities) {
      const container = document.getElementById('activity-checkboxes');
      container.innerHTML = '';
      const anyId = 'activity-any';
      const anyBox = document.createElement('label');
      anyBox.innerHTML = `<input type="checkbox" id="${anyId}" name="activities" value="Any" checked> Any`;
      container.appendChild(anyBox);
      container.appendChild(document.createElement('br'));
      activities.forEach(act => {
        const id = `activity-${act.replace(/\s+/g,'-').toLowerCase()}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" id="${id}" name="activities" value="${act}" checked> ${act}`;
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });
    }

    function getSelectedActivities() {
      const checkboxes = document.querySelectorAll('input[name="activities"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }

    function renderOpportunities(opps, orgs, activities) {
      const section = document.getElementById('opportunity-list');
      if (!opps.length) {
        section.innerHTML = `<div class="no-opps-msg">No matching opportunities found.</div>`;
        return;
      }
      let html = '';
      const orgMap = {};
      opps.forEach(opp => {
        if (!orgMap[opp.orgName]) orgMap[opp.orgName] = { activities: [], link: opp.orgLink };
        console.log(opp.orgLink);
        orgMap[opp.orgName].activities.push(opp.activity);
      });
      Object.keys(orgMap).forEach(orgName => {
        const orgData = orgMap[orgName];
        const hasLink = orgData.link && typeof orgData.link === 'string' && orgData.link.trim() !== '';
        html += `<div class="opportunity-item">
          <img src="${getOrgImg(orgName)}" alt="${orgName}" class="opportunity-img">
          <div>
            <div class="opportunity-org">${orgName}</div>
            <ul class="opportunity-activities">
              ${orgData.activities.map(a => `<li>${a}</li>`).join('')}
            </ul>
            ${
              hasLink
                ? `<a href="${orgData.link}" target="_blank" style="font-size:1em;display:inline-block;margin-top:0.5em;color:#0a7;">Sign Up / Learn More</a>`
                : ''
            }
          </div>
        </div>`;
      });
      section.innerHTML = html;
    }

    function filterOpportunities() {
      let orgs = getSelectedOrgs();
      let acts = getSelectedActivities();
      let filtered = allOpportunities;
      if (!orgs.includes('Any')) {
        filtered = filtered.filter(opp => orgs.includes(opp.orgName));
      }
      if (!acts.includes('Any')) {
        filtered = filtered.filter(opp => acts.includes(opp.activity));
      }
      renderOpportunities(filtered, allOrganizations, allActivities);
    }

    // Checkbox "Any" logic for activities only
    function setupActivityAnyCheckboxLogic() {
      const actContainer = document.getElementById('activity-checkboxes');
      actContainer.addEventListener('change', e => {
        if (e.target.name === 'activities') {
          const anyBox = actContainer.querySelector('input[value="Any"]');
          const allBoxes = Array.from(actContainer.querySelectorAll('input[type="checkbox"]:not([value="Any"])'));
          if (e.target.value === 'Any') {
            allBoxes.forEach(cb => cb.checked = anyBox.checked);
          } else {
            if (!e.target.checked) anyBox.checked = false;
            if (allBoxes.every(cb => cb.checked)) anyBox.checked = true;
          }
          filterOpportunities();
        }
      });
    }

    // ---- Page initialization ----
    document.addEventListener("DOMContentLoaded", function() {
      async function initializeVolunteerPage() {
        allOrganizations = await fetchOrganizations();
        renderOrgDropdowns(allOrganizations);

        allOpportunities = await fetchAllOpportunities();

        const actSet = new Set(allOpportunities.map(o => o.activity));
        allActivities = Array.from(actSet).sort();
        renderActivityCheckboxes(allActivities);

        renderOpportunities(allOpportunities, allOrganizations, allActivities);

        setupOrgDropdownLogic();
        setupActivityAnyCheckboxLogic();
      }

      initializeVolunteerPage();

      // ---- Disclaimer popover logic ----
      const disclaimerLink = document.getElementById('disclaimer-link');
      const disclaimerPopover = document.getElementById('disclaimer-popover');
      const closeDisclaimer = document.getElementById('close-disclaimer');
      if(disclaimerLink && disclaimerPopover && closeDisclaimer){
        disclaimerLink.addEventListener('click', function(e) {
          e.preventDefault();
          disclaimerPopover.style.display = 'block';
        });
        closeDisclaimer.addEventListener('click', function() {
          disclaimerPopover.style.display = 'none';
        });
        window.addEventListener('click', function(e) {
          if (disclaimerPopover.style.display === 'block' && !disclaimerPopover.contains(e.target) && e.target !== disclaimerLink) {
            disclaimerPopover.style.display = 'none';
          }
        });
      }
    });
  </script>
</body>
</html>