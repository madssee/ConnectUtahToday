<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Event Calendar</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="calendar.html">Calendar</a> |
    <a href="events.html">Events</a> |
    <a href="volunteer.html">Volunteering</a> |
    <a href="support.html">Support a Cause</a> |
    <a href="latest-updates.html">Latest Updates</a> |
    <a href="activism.html">Activism</a>
  </nav>
  <main>
    <h1>Event Calendar</h1>
    <div style="text-align:left; margin: 1.5em 0 0.5em 0;">
      <a href="#" id="calendar-disclaimer-link" style="font-size:0.92em;text-decoration:underline;cursor:pointer;">Disclaimer</a>
    </div>
    <!-- Custom Interactive Calendar Grid -->
    <div style="margin: 2em 0;">
      <div style="text-align: center; margin-bottom: 1em;">
        <button id="prev-cal-month" style="margin-right:1em;padding:0.5em 0.75em;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">&#8592;</button>
        <input type="text" id="current-cal-month" value="August 2025" style="font-weight:bold;font-size:1.2em;text-align:center;border:2px solid #dee2e6;border-radius:6px;padding:0.5em 1em;margin:0 0.5em;min-width:200px;background:#f8f9fa;" placeholder="Month YYYY" />
        <button id="next-cal-month" style="margin-left:1em;padding:0.5em 0.75em;background:#007bff;color:white;border:none;border-radius:4px;cursor:pointer;">&#8594;</button>
      </div>
      <div style="text-align: center; margin-bottom: 1em; font-size: 0.9em; color: #6c757d;">
        <span>Type month and year (e.g., "January 2025" or "1/2025") and press Enter</span>
      </div>
      <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; max-width: 600px; margin: 0 auto; background: #ddd; border: 1px solid #ddd;">
        <!-- Day headers -->
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Sun</div>
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Mon</div>
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Tue</div>
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Wed</div>
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Thu</div>
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Fri</div>
        <div style="background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold;">Sat</div>
        <!-- Calendar days will be generated by JavaScript -->
        <div id="calendar-grid" style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px;">
          <!-- Days -->
        </div>
      </div>
      <div style="margin-top: 1em; text-align: center;">
        <p>Click on a day with events to see event details.</p>
      </div>
    </div>
  </main>

  <div id="calendar-disclaimer-popover" style="display:none;position:fixed;top:22%;left:50%;transform:translate(-50%,0);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:520px;z-index:1000;border-radius:8px;font-size:0.97em; text-align:left;">
    <strong>Disclaimer:</strong> Connect Utah Today provides a list of events for informational purposes only. We do not organize, operate, or officially endorse any of the events listed on this website unless explicitly stated. Event details, dates, times, and locations are subject to change without notice. Connect Utah Today is not responsible for the accuracy, reliability, or completeness of the information provided, nor for any issues, injuries, or losses that may arise from your participation in any event. Please verify event details directly with the event organizer before attending. By using this website, you acknowledge and accept that Connect Utah Today is not liable for any consequences resulting from your participation in or reliance on any event listed.
    <br><br>
    <button id="close-calendar-disclaimer" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
  </div>

  <!-- Event Details Popover -->
  <div id="event-details-overlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);z-index:998;"></div>
  <div id="event-details-popover" style="display:none;position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:none;box-shadow:0 20px 60px rgba(0,0,0,0.3);padding:0;max-width:850px;max-height:85vh;overflow-y:auto;z-index:999;border-radius:16px;min-width:600px;">
    <div style="padding:2em 2.5em;border-bottom:1px solid #eee;background:linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <h2 id="event-title" style="margin:0;color:#212529;font-size:1.8em;line-height:1.2;font-weight:600;">Events</h2>
        <button id="close-event-details" style="background:#fff;border:2px solid #dee2e6;border-radius:50%;width:40px;height:40px;font-size:1.2em;color:#6c757d;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s ease;box-shadow:0 2px 4px rgba(0,0,0,0.1);">&times;</button>
      </div>
    </div>
    <div style="padding:2em 2.5em;">
      <div id="event-details-content">
        <!-- Event details -->
      </div>
    </div>
  </div>

  <script>
    const orgImageMap = {
      'DSA': '/ConnectUtahToday/assets/DSA.jpg',
      'Democratic Socialists': '/ConnectUtahToday/assets/DSA.jpg',
      'PSL': '/ConnectUtahToday/assets/psl.jpg',
      'Party for Socialism': '/ConnectUtahToday/assets/psl.jpg',
      'Brown Berets': '/ConnectUtahToday/assets/BrownBerets.png',
      'SLC Mutual Aid': '/ConnectUtahToday/assets/SLCMutualAid.png',
      'Mutual Aid': '/ConnectUtahToday/assets/SLCMutualAid.png',
      'Wild Utah': '/ConnectUtahToday/assets/WildUtah.png',
      'Indivisible': '/ConnectUtahToday/assets/indivisible.png',
      'Beehive Collective': '/ConnectUtahToday/assets/beehiveCollectivePlaceholder.jpg',
      'Bakers for Palestine': '/ConnectUtahToday/assets/bakers_for_palestine_SLC.jpg'
    };
    const placeholderImage = '/ConnectUtahToday/assets/placeholder.jpg';

    // --- Calendar Logic ---
    let currentCalDate = new Date();
    let calendarEvents = {};
/* TEMPORARY FIX - prevent API payload from overwhelming UI and causing timeout
    // Render API endpoint for calendar
    function getCalendarApiUrlForMonth(date) {
      // Build first day and last day of target month
      const year = date.getFullYear();
      const month = date.getMonth();
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0, 23, 59, 59);
      const startISO = start.toISOString();
      const endISO = end.toISOString();
      return `https://connectutahtoday-1.onrender.com/api/all-events?timeMin=${encodeURIComponent(startISO)}&timeMax=${encodeURIComponent(endISO)}`;
    }
*/
// this function caps for one week, see comment above
    function getCalendarApiUrlForMonth(date) {
        // Use the current date or the selected date as the range start
      const year = date.getFullYear();
      const month = date.getMonth();
      const day = date.getDate();
      const start = new Date(year, month, day); // Start from the current/selected day
      const end = new Date(year, month, day + 6, 23, 59, 59); // End 6 days later (7 days total)
      const startISO = start.toISOString();
      const endISO = end.toISOString();
      return `https://connectutahtoday-1.onrender.com/api/all-events?timeMin=${encodeURIComponent(startISO)}&timeMax=${encodeURIComponent(endISO)}`;
    }
    // Fetch events from Render backend (Google Calendar proxy)
    async function fetchEventsForCalendar() {
      try {
        const apiUrl = getCalendarApiUrlForMonth(currentCalDate);
        const response = await fetch(apiUrl);
        const data = await response.json();
        const events = (data.items || []).map(event => ({
          // Adapt Google event format to local format
          title: event.summary || event.title || 'Untitled Event',
          date: event.start?.dateTime || event.start?.date,
          location: event.location,
          description: event.description,
          url: event.htmlLink || event.url,
          source: 'google',
          featured_image_url: event.featured_image_url,
          event_type: event.event_type
        }));
        // Group by date (YYYY-M-D)
        calendarEvents = {};
        events.forEach(event => {
          if (!event.date) return;
          const eventDateObj = new Date(event.date);
          if (isNaN(eventDateObj.getTime())) return;
          const key = `${eventDateObj.getFullYear()}-${eventDateObj.getMonth()}-${eventDateObj.getDate()}`;
          if (!calendarEvents[key]) calendarEvents[key] = [];
          calendarEvents[key].push(event);
        });
        renderCalendar();
      } catch (error) {
        console.error('Error fetching events for calendar:', error);
        renderCalendar();
      }
    }

    // Calendar rendering logic (unchanged, but uses new calendarEvents)
    function renderCalendar() {
      const year = currentCalDate.getFullYear();
      const month = currentCalDate.getMonth();
      // Update month label
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
      document.getElementById('current-cal-month').value = `${monthNames[month]} ${year}`;
      // Get first day of month and number of days
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      // Clear existing calendar
      const grid = document.getElementById('calendar-grid');
      grid.innerHTML = '';
      // Add empty cells for days before month starts
      for (let i = 0; i < firstDay; i++) {
        const cell = document.createElement('div');
        cell.style.cssText = 'background: #f9f9f9; padding: 10px; min-height: 60px; border: 1px solid #eee;';
        grid.appendChild(cell);
      }
      // Add days of month
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const cell = document.createElement('div');
        const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
        const dateKey = `${year}-${month}-${day}`;
        const dayEvents = calendarEvents[dateKey] || [];
        const hasEvents = dayEvents.length > 0;
        let cellStyle = 'background: #fff; padding: 10px; min-height: 60px; border: 1px solid #eee; position: relative;';
        if (isToday) cellStyle += ' background: #e3f2fd; font-weight: bold;';
        if (hasEvents) cellStyle += ' cursor: pointer;';
        cell.style.cssText = cellStyle;
        let cellHTML = `<div style="font-weight: ${isToday ? 'bold' : 'normal'};">${day}</div>`;
        // Add event indicators
        if (hasEvents) {
          cellHTML += `<div style="position: absolute; bottom: 4px; left: 4px; right: 4px;">`;
          for (let i = 0; i < Math.min(3, dayEvents.length); i++) {
            const event = dayEvents[i];
            const eventTitle = event.title || 'Event';
            const shortTitle = eventTitle.length > 12 ? eventTitle.substring(0, 12) + '...' : eventTitle;
            cellHTML += `<div style="font-size: 9px; background: #1976d2; color: white; padding: 1px 3px; margin: 1px 0; border-radius: 2px; overflow: hidden;">${shortTitle}</div>`;
          }
          if (dayEvents.length > 3) {
            cellHTML += `<div style="font-size: 10px; color: #1976d2; font-weight: bold;">+${dayEvents.length - 3}</div>`;
          }
          cellHTML += `</div>`;
          cellHTML += `<div style="font-size: 10px; color: #666; margin-top: 2px;">${dayEvents.length} event${dayEvents.length !== 1 ? 's' : ''}</div>`;
        }
        cell.innerHTML = cellHTML;
        if (hasEvents) {
          cell.addEventListener('click', function() {
            showEventDetails(dayEvents, day, month, year);
          });
        }
        grid.appendChild(cell);
      }
    }

    // Event details popover (image sources updated to absolute paths)
    function showEventDetails(events, day, month, year) {
      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];
      let popoverContent = `<div style="text-align:center;margin-bottom:2em;padding:1em;background:#f8f9fa;border-radius:8px;border-left:4px solid #007bff;">
        <h3 style="margin:0;color:#495057;font-size:1.3em;font-weight:500;">${monthNames[month]} ${day}, ${year}</h3>
        <p style="margin:0.5em 0 0 0;color:#6c757d;font-size:0.95em;">${events.length} event${events.length !== 1 ? 's' : ''} scheduled</p>
      </div>`;
      events.forEach((event, index) => {
        if (index > 0) {
          popoverContent += '<div style="margin:2em 0;border-top:2px solid #e9ecef;"></div>';
        }
        // Determine image source
        let eventImage = placeholderImage;
        if (event.source === 'mobilize' && event.featured_image_url) {
          eventImage = event.featured_image_url;
        } else if (event.source === 'google') {
          const eventTitle = (event.title || '').toLowerCase();
          const eventLocation = (event.location || '').toLowerCase();
          const eventDescription = (event.description || '').toLowerCase();
          const searchText = `${eventTitle} ${eventLocation} ${eventDescription}`;
          for (const [org, imagePath] of Object.entries(orgImageMap)) {
            if (searchText.includes(org.toLowerCase())) {
              eventImage = imagePath;
              break;
            }
          }
        }
        popoverContent += `<div style="display:flex;gap:1.5em;margin-bottom:1.5em;background:#fff;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.08);overflow:hidden;border:1px solid #e9ecef;">`;
        // Event image
        popoverContent += `<div style="flex-shrink:0;width:200px;height:150px;overflow:hidden;">
          <img src="${eventImage}" alt="Event image" style="width:100%;height:100%;object-fit:cover;" onError="this.src='${placeholderImage}';">
        </div>`;
        // Event content
        popoverContent += `<div style="flex:1;padding:1.5em;display:flex;flex-direction:column;">`;
        // Event title
        popoverContent += `<h3 style="margin:0 0 0.75em 0;color:#212529;font-size:1.3em;font-weight:600;line-height:1.3;">${event.title || 'Untitled Event'}</h3>`;
        // Event details grid
        popoverContent += `<div style="display:grid;grid-template-columns:auto 1fr;gap:0.5em 1em;margin-bottom:1em;font-size:0.95em;">`;
        // Date and time
        if (event.date) {
          const eventDate = new Date(event.date);
          const timeStr = eventDate.toLocaleTimeString('en-US', {
            hour: 'numeric',
            minute: '2-digit',
            hour12: true
          });
          const dateStr = eventDate.toLocaleDateString('en-US', {
            weekday: 'long',
            month: 'long',
            day: 'numeric'
          });
          popoverContent += `<span style="color:#6c757d;font-weight:500;">üìÖ Date:</span><span style="color:#495057;">${dateStr}</span>`;
          popoverContent += `<span style="color:#6c757d;font-weight:500;">üïê Time:</span><span style="color:#495057;">${timeStr}</span>`;
        }
        // Location
        if (event.location) {
          popoverContent += `<span style="color:#6c757d;font-weight:500;">üìç Location:</span><span style="color:#495057;">${event.location}</span>`;
        }
        // Source
        const source = event.source === 'google' ? 'Google Calendar' : 'Mobilize';
        const sourceIcon = event.source === 'google' ? 'üìÖ' : 'üì¢';
        popoverContent += `<span style="color:#6c757d;font-weight:500;">${sourceIcon} Source:</span><span style="color:#495057;">${source}</span>`;
        popoverContent += `</div>`;
        // Description
        if (event.description) {
          const shortDesc = event.description.length > 300 
            ? event.description.substring(0, 300) + '...' 
            : event.description;
          popoverContent += `<div style="color:#495057;line-height:1.5;margin-bottom:1em;font-size:0.95em;background:#f8f9fa;padding:1em;border-radius:8px;border-left:3px solid #28a745;">${shortDesc}</div>`;
        }
        // Action buttons
        popoverContent += `<div style="margin-top:auto;display:flex;gap:0.75em;flex-wrap:wrap;">`;
        // Event URL
        if (event.url) {
          popoverContent += `<a href="${event.url}" target="_blank" rel="noopener" style="background:#007bff;color:white;padding:0.75em 1.5em;text-decoration:none;border-radius:6px;font-weight:500;font-size:0.9em;display:inline-flex;align-items:center;gap:0.5em;transition:background 0.2s ease;box-shadow:0 2px 4px rgba(0,123,255,0.2);">
            <span>View Details</span> <span style="font-size:1.1em;">‚Üí</span>
          </a>`;
        }
        // Mobilize-specific buttons
        if (event.source === 'mobilize' && event.event_type) {
          popoverContent += `<span style="background:#28a745;color:white;padding:0.5em 1em;border-radius:6px;font-size:0.85em;font-weight:500;">${event.event_type}</span>`;
        }
        popoverContent += `</div>`;
        popoverContent += `</div></div>`;
      });
      document.getElementById('event-details-content').innerHTML = popoverContent;
      document.getElementById('event-details-overlay').style.display = 'block';
      document.getElementById('event-details-popover').style.display = 'block';
    }

    function hideEventDetails() {
      document.getElementById('event-details-overlay').style.display = 'none';
      document.getElementById('event-details-popover').style.display = 'none';
    }

    // Month/year input parsing
    function parseMonthYear(input) {
      const monthNames = ["january", "february", "march", "april", "may", "june",
        "july", "august", "september", "october", "november", "december"];
      const monthAbbrevs = ["jan", "feb", "mar", "apr", "may", "jun",
        "jul", "aug", "sep", "oct", "nov", "dec"];
      input = input.toLowerCase().trim();
      let month = -1, year = -1;
      const monthYearMatch = input.match(/^(\w+)\s+(\d{4})$/);
      if (monthYearMatch) {
        const monthStr = monthYearMatch[1];
        year = parseInt(monthYearMatch[2]);
        month = monthNames.indexOf(monthStr);
        if (month === -1) month = monthAbbrevs.indexOf(monthStr);
      }
      const numericMatch = input.match(/^(\d{1,2})\/(\d{4})$/);
      if (numericMatch && month === -1) {
        month = parseInt(numericMatch[1]) - 1;
        year = parseInt(numericMatch[2]);
        if (month < 0 || month > 11) month = -1;
      }
      const reverseMatch = input.match(/^(\d{4})[-\/](\d{1,2})$/);
      if (reverseMatch && month === -1) {
        year = parseInt(reverseMatch[1]);
        month = parseInt(reverseMatch[2]) - 1;
        if (month < 0 || month > 11) month = -1;
      }
      if (year < 1900 || year > 2100) year = -1;
      return { month, year };
    }

    function navigateToDate(month, year) {
      if (month >= 0 && month <= 11 && year >= 1900 && year <= 2100) {
        currentCalDate = new Date(year, month, 1);
        fetchEventsForCalendar();
        return true;
      }
      return false;
    }

    document.getElementById('prev-cal-month').addEventListener('click', function() {
      currentCalDate.setMonth(currentCalDate.getMonth() - 1);
      fetchEventsForCalendar();
    });

    document.getElementById('next-cal-month').addEventListener('click', function() {
      currentCalDate.setMonth(currentCalDate.getMonth() + 1);
      fetchEventsForCalendar();
    });

    // Handle month/year input field
    const monthInput = document.getElementById('current-cal-month');
    let originalValue = monthInput.value;

    // Handle Enter key and blur events
    monthInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        this.blur();
      }
    });

    monthInput.addEventListener('blur', function() {
      const inputValue = this.value.trim();
      if (inputValue === originalValue) return;
      const parsed = parseMonthYear(inputValue);
      if (parsed.month !== -1 && parsed.year !== -1) {
        const success = navigateToDate(parsed.month, parsed.year);
        if (success) {
          originalValue = this.value;
        } else {
          this.value = originalValue;
          this.style.background = '#ffebee';
          setTimeout(() => {
            this.style.background = '#f8f9fa';
          }, 1000);
        }
      } else {
        this.style.background = '#ffebee';
        this.style.borderColor = '#f44336';
        const errorMsg = document.createElement('div');
        errorMsg.textContent = 'Invalid format. Try "January 2025" or "1/2025"';
        errorMsg.style.cssText = 'position:absolute;background:#f44336;color:white;padding:0.5em 1em;border-radius:4px;font-size:0.85em;margin-top:0.5em;z-index:1000;left:50%;transform:translateX(-50%);';
        this.parentNode.style.position = 'relative';
        this.parentNode.appendChild(errorMsg);
        setTimeout(() => {
          this.value = originalValue;
          this.style.background = '#f8f9fa';
          this.style.borderColor = '#dee2e6';
          if (errorMsg.parentNode) {
            errorMsg.parentNode.removeChild(errorMsg);
          }
        }, 2000);
      }
    });

    monthInput.addEventListener('focus', function() {
      originalValue = this.value;
      this.select();
    });

    // Initialize calendar with events
    fetchEventsForCalendar();

    // Disclaimer popover logic (from both files)
    const calDisclaimerLink = document.getElementById('calendar-disclaimer-link');
    const calDisclaimerPopover = document.getElementById('calendar-disclaimer-popover');
    const closeCalDisclaimer = document.getElementById('close-calendar-disclaimer');
    calDisclaimerLink.addEventListener('click', function(e) {
      e.preventDefault();
      calDisclaimerPopover.style.display = 'block';
    });
    closeCalDisclaimer.addEventListener('click', function() {
      calDisclaimerPopover.style.display = 'none';
    });
    window.addEventListener('click', function(e) {
      if (calDisclaimerPopover.style.display === 'block' && !calDisclaimerPopover.contains(e.target) && e.target !== calDisclaimerLink) {
        calDisclaimerPopover.style.display = 'none';
      }
    });

    // Event details popover logic
    document.getElementById('close-event-details').addEventListener('click', hideEventDetails);
    document.getElementById('event-details-overlay').addEventListener('click', hideEventDetails);
    const closeBtn = document.getElementById('close-event-details');
    closeBtn.addEventListener('mouseenter', function() {
      this.style.background = '#f8f9fa';
      this.style.borderColor = '#adb5bd';
      this.style.transform = 'scale(1.05)';
    });
    closeBtn.addEventListener('mouseleave', function() {
      this.style.background = '#fff';
      this.style.borderColor = '#dee2e6';
      this.style.transform = 'scale(1)';
    });
    document.getElementById('event-details-popover').addEventListener('click', function(e) {
      e.stopPropagation();
    });
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        hideEventDetails();
      }
    });
  </script>
</body>
</html>