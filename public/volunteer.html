<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Volunteering</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .filter-section {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
      max-width: 600px;
      margin: 2em auto 1.5em auto;
      padding: 2em 1.5em;
    }
    .opportunity-list {
      max-width: 700px;
      margin: 0 auto 3em auto;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.11);
      padding: 2em 1.5em;
    }
    .opportunity-item {
      display: flex;
      align-items: flex-start;
      margin-bottom: 1.5em;
      border-bottom: 1px solid #eee;
      padding-bottom: 1.2em;
    }
    .opportunity-item:last-child {
      border-bottom: none;
    }
    .opportunity-img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 8px;
      margin-right: 1.2em;
      background: #eee;
    }
    .opportunity-org {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: .2em;
    }
    .opportunity-activities {
      margin: .25em 0 0 1.2em;
      padding: 0;
      list-style: circle;
    }
    .no-opps-msg {
      text-align: center;
      color: #555;
      margin: 2em 0 1em 0;
      font-size: 1.1em;
    }
  </style>
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="calendar.html">Calendar</a> |
    <a href="events.html">Events</a> |
    <a href="volunteer.html">Volunteering</a> |
    <a href="support.html">Support a Cause</a> |
    <a href="latest-updates.html">Latest Updates</a> |
    <a href="local-issues.html">Local Issues</a>
  </nav>
  <div style="text-align:right; margin: 0.5em 2em 0 0;">
    <a href="org-signin.html" id="org-signin-link" style="font-size:0.97em;text-decoration:underline;cursor:pointer;">Organization sign-in</a>
  </div>
  <main>
    <h1>Volunteer for Local Events and Organizations</h1>
    <p style="font-size:0.97em;">
      Be matched with volunteer opportunities with local organizations by selecting the boxes of interest to you below.
      <a href="#" id="disclaimer-link" style="font-size:0.92em;text-decoration:underline;cursor:pointer;">Disclaimer</a>
    </p>
    <section class="filter-section">
      <form id="volunteer-filter-form">
        <fieldset style="margin-bottom:1.5em;">
          <legend><strong>Organization:</strong></legend>
          <div id="org-checkboxes">
            <span style="color:#888;">Loading organizations...</span>
          </div>
        </fieldset>
        <fieldset style="margin-bottom:1.5em;">
          <legend><strong>Activities:</strong></legend>
          <div id="activity-checkboxes">
            <span style="color:#888;">Loading activities...</span>
          </div>
        </fieldset>
      </form>
    </section>
    <section class="opportunity-list" id="opportunity-list">
      <div style="color:#888;">Loading opportunities...</div>
    </section>
  </main>
  <div id="disclaimer-popover" style="display:none;position:fixed;top:22%;left:50%;transform:translate(-50%,0);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:520px;z-index:1000;border-radius:8px;font-size:0.97em;">
    <strong>Disclaimer:</strong> Connect Utah Today provides links to external organizations offering volunteer opportunities for informational purposes only. We do not endorse, guarantee, or assume responsibility for the organizations listed or the opportunities they provide. All volunteering arrangements are made directly between you and the respective organization. Connect Utah Today does not verify the legitimacy, safety, or quality of any volunteer opportunity or organization, and is not responsible for any outcomes, experiences, or issues arising from your participation. Please conduct your own due diligence before engaging with any organization. By clicking on a volunteer opportunity link, you will be redirected to a third-party website and subject to their terms, conditions, and privacy policies. Connect Utah Today is not responsible for the content or practices of any linked site.
    <br><br>
    <button id="close-disclaimer" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
  </div>
  <script>
    // ---- Utility: Org Name to Asset Normalization ----
    function orgNameToAsset(orgName) {
      return orgName.toLowerCase().replace(/\s+/g, '_');
    }
    function getOrgImg(orgName) {
      return `assets/${orgNameToAsset(orgName)}.png`;
    }

    // ---- State ----
    let allOrganizations = [];
    let allOpportunities = [];
    let allActivities = [];

    // ---- Fetch data and initialize filters ----
    async function fetchOrganizations() {
      const res = await fetch('https://connectutahtoday-1.onrender.com/api/organizations');
      const data = await res.json();
      return data.organizations || [];
    }

    async function fetchAllOpportunities() {
      // 1. Fetch all organizations first to get their IDs
      const orgs = await fetchOrganizations();
      // 2. For each org, fetch its opportunities
      const allOpps = [];
      for (let org of orgs) {
        const res = await fetch(`https://connectutahtoday-1.onrender.com/api/opportunities?organization_id=${org.id}`);
        const data = await res.json();
        (data.opportunities || []).forEach(opp => {
          allOpps.push({
            orgId: org.id,
            orgName: org.name,
            activity: opp
          });
        });
      }
      return allOpps;
    }

    // ---- Render filter checkboxes ----
    function renderOrgCheckboxes(orgs) {
      const container = document.getElementById('org-checkboxes');
      container.innerHTML = '';
      // "Any" checkbox
      const anyId = 'org-any';
      const anyBox = document.createElement('label');
      anyBox.innerHTML = `<input type="checkbox" id="${anyId}" name="orgs" value="Any" checked> Any`;
      container.appendChild(anyBox);
      container.appendChild(document.createElement('br'));
      // Each org
      orgs.forEach(org => {
        const id = `org-${org.id}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" id="${id}" name="orgs" value="${org.name}" checked> ${org.name}`;
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });
    }
    function renderActivityCheckboxes(activities) {
      const container = document.getElementById('activity-checkboxes');
      container.innerHTML = '';
      // "Any" checkbox
      const anyId = 'activity-any';
      const anyBox = document.createElement('label');
      anyBox.innerHTML = `<input type="checkbox" id="${anyId}" name="activities" value="Any" checked> Any`;
      container.appendChild(anyBox);
      container.appendChild(document.createElement('br'));
      // Each activity
      activities.forEach(act => {
        const id = `activity-${act.replace(/\s+/g,'-').toLowerCase()}`;
        const label = document.createElement('label');
        label.innerHTML = `<input type="checkbox" id="${id}" name="activities" value="${act}" checked> ${act}`;
        container.appendChild(label);
        container.appendChild(document.createElement('br'));
      });
    }

    // Render opportunity list
    function renderOpportunities(opps, orgs, activities) {
      const section = document.getElementById('opportunity-list');
      if (!opps.length) {
        section.innerHTML = `<div class="no-opps-msg">No matching opportunities found.</div>`;
        return;
      }
      let html = '';
      // Group by org for better UX
      const orgMap = {};
      opps.forEach(opp => {
        if (!orgMap[opp.orgName]) orgMap[opp.orgName] = [];
        orgMap[opp.orgName].push(opp.activity);
      });
      Object.keys(orgMap).forEach(orgName => {
        html += `<div class="opportunity-item">
          <img src="${getOrgImg(orgName)}" alt="${orgName}" class="opportunity-img">
          <div>
            <div class="opportunity-org">${orgName}</div>
            <ul class="opportunity-activities">
              ${orgMap[orgName].map(a => `<li>${a}</li>`).join('')}
            </ul>
            <!-- Optionally add a Sign Up link if you have org URLs -->
          </div>
        </div>`;
      });
      section.innerHTML = html;
    }

    // Filtering logic
    function getSelectedOrgs() {
      const checkboxes = document.querySelectorAll('input[name="orgs"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    function getSelectedActivities() {
      const checkboxes = document.querySelectorAll('input[name="activities"]:checked');
      return Array.from(checkboxes).map(cb => cb.value);
    }
    function filterOpportunities() {
      let orgs = getSelectedOrgs();
      let acts = getSelectedActivities();
      let filtered = allOpportunities;
      if (!orgs.includes('Any')) {
        filtered = filtered.filter(opp => orgs.includes(opp.orgName));
      }
      if (!acts.includes('Any')) {
        filtered = filtered.filter(opp => acts.includes(opp.activity));
      }
      renderOpportunities(filtered, allOrganizations, allActivities);
    }

    // Checkbox "Any" logic
    function setupAnyCheckboxLogic() {
      // For orgs
      const orgContainer = document.getElementById('org-checkboxes');
      orgContainer.addEventListener('change', e => {
        if (e.target.name === 'orgs') {
          const anyBox = orgContainer.querySelector('input[value="Any"]');
          const allBoxes = Array.from(orgContainer.querySelectorAll('input[type="checkbox"]:not([value="Any"])'));
          if (e.target.value === 'Any') {
            // Toggling Any: check/uncheck all
            allBoxes.forEach(cb => cb.checked = anyBox.checked);
          } else {
            // Toggling an org: if any is unchecked, uncheck Any; if all orgs checked, check Any
            if (!e.target.checked) anyBox.checked = false;
            if (allBoxes.every(cb => cb.checked)) anyBox.checked = true;
          }
          filterOpportunities();
        }
      });
      // For activities
      const actContainer = document.getElementById('activity-checkboxes');
      actContainer.addEventListener('change', e => {
        if (e.target.name === 'activities') {
          const anyBox = actContainer.querySelector('input[value="Any"]');
          const allBoxes = Array.from(actContainer.querySelectorAll('input[type="checkbox"]:not([value="Any"])'));
          if (e.target.value === 'Any') {
            allBoxes.forEach(cb => cb.checked = anyBox.checked);
          } else {
            if (!e.target.checked) anyBox.checked = false;
            if (allBoxes.every(cb => cb.checked)) anyBox.checked = true;
          }
          filterOpportunities();
        }
      });
    }

    // ---- Page initialization ----
    async function initializeVolunteerPage() {
      allOrganizations = await fetchOrganizations();
      renderOrgCheckboxes(allOrganizations);

      allOpportunities = await fetchAllOpportunities();

      const actSet = new Set(allOpportunities.map(o => o.activity));
      allActivities = Array.from(actSet).sort();
      renderActivityCheckboxes(allActivities);

      renderOpportunities(allOpportunities, allOrganizations, allActivities);

      setupAnyCheckboxLogic();
    }

    initializeVolunteerPage();

    // ---- Disclaimer popover logic ----
    const disclaimerLink = document.getElementById('disclaimer-link');
    const disclaimerPopover = document.getElementById('disclaimer-popover');
    const closeDisclaimer = document.getElementById('close-disclaimer');
    disclaimerLink.addEventListener('click', function(e) {
      e.preventDefault();
      disclaimerPopover.style.display = 'block';
    });
    closeDisclaimer.addEventListener('click', function() {
      disclaimerPopover.style.display = 'none';
    });
    window.addEventListener('click', function(e) {
      if (disclaimerPopover.style.display === 'block' && !disclaimerPopover.contains(e.target) && e.target !== disclaimerLink) {
        disclaimerPopover.style.display = 'none';
      }
    });
  </script>
</body>
</html>
