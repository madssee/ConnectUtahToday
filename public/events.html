<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Events</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <nav>
    <a href="index.html">Home</a> |
    <a href="calendar.html">Calendar</a> |
    <a href="events.html">Events</a> |
    <a href="volunteer.html">Volunteering</a> |
    <a href="support.html">Support a Cause</a> |
    <a href="latest-updates.html">Latest Updates</a> |
    <a href="local-issues.html">Local Issues</a>
  </nav>
  <main>
    <h1>Upcoming Events</h1>
    <div style="text-align:left; margin: 1.5em 0 0.5em 0;">
      <a href="#" id="events-disclaimer-link" style="font-size:0.92em;text-decoration:underline;cursor:pointer;">Disclaimer</a>
    </div>
    <!-- Month Navigation -->
    <div id="month-navigation" style="margin: 2em 0; text-align: left; max-width: 700px;">
      <button id="prev-month" style="margin-right:1em;">&#8592; Previous Month</button>
      <span id="current-month-label" style="font-weight:bold;"></span>
      <button id="next-month" style="margin-left:1em;">Next Month &#8594;</button>
    </div>
    <!-- Event Feed -->
    <div id="event-feed" style="margin-top: 20px;">
      <h2>Events</h2>

      <!-- Date Filter Controls -->
      <div id="filter-controls" style="margin-bottom: 20px; padding: 15px; background: #f5f5f5; border-radius: 8px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <label style="font-weight: bold;">Filter by:</label>

          <div>
            <label>
              <input type="radio" name="filter-type" value="all" checked> All Events
            </label>
          </div>

          <div>
            <label>
              <input type="radio" name="filter-type" value="month"> Month:
            </label>
            <input type="month" id="month-filter" style="margin-left: 5px;" disabled>
          </div>

          <div>
            <label>
              <input type="radio" name="filter-type" value="week"> Week of:
            </label>
            <input type="date" id="week-filter" style="margin-left: 5px;" disabled>
          </div>

          <div>
            <label>
              <input type="radio" name="filter-type" value="day"> Specific Day:
            </label>
            <input type="date" id="day-filter" style="margin-left: 5px;" disabled>
          </div>

          <div>
            <label>
              <input type="radio" name="filter-type" value="range"> Date Range:
            </label>
            <input type="date" id="start-date-filter" style="margin-left: 5px;" disabled>
            <span style="margin: 0 5px;">to</span>
            <input type="date" id="end-date-filter" disabled>
          </div>
        </div>

        <div style="margin-top: 10px;">
          <button id="apply-filter" style="padding: 8px 16px; background: #007cba; color: white; border: none; border-radius: 4px; cursor: pointer;">Apply Filter</button>
          <button id="clear-filter" style="padding: 8px 16px; background: #666; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 10px;">Clear Filter</button>
        </div>
      </div>

      <div id="event-list">Loading events...</div>
    </div>
  </main>

  <div id="events-disclaimer-popover" style="display:none;position:fixed;top:22%;left:50%;transform:translate(-50%,0);background:#fff;border:1px solid #888;box-shadow:0 4px 24px rgba(0,0,0,0.18);padding:2em;max-width:520px;z-index:1000;border-radius:8px;font-size:0.97em; text-align:left;">
    <strong>Disclaimer:</strong> Connect Utah Today provides a list of events for informational purposes only. We do not organize, operate, or officially endorse any of the events listed on this website unless explicitly stated. Event details, dates, times, and locations are subject to change without notice. Connect Utah Today is not responsible for the accuracy, reliability, or completeness of the information provided, nor for any issues, injuries, or losses that may arise from your participation in any event. Please verify event details directly with the event organizer before attending. By using this website, you acknowledge and accept that Connect Utah Today is not liable for any consequences resulting from your participation in or reliance on any event listed.
    <br><br>
    <button id="close-events-disclaimer" style="margin-top:1em;padding:0.5em 1.5em;">Close</button>
  </div>
  <script>
    // --- Month Navigation Logic & Absolute Image Paths ---
    const imageMap = {
      'SLC Mutual Aid': '/ConnectUtahToday/assets/SLCMutualAid.png',
      'Brown Berets': '/ConnectUtahToday/assets/BrownBerets.png',
      'Wild Utah': '/ConnectUtahToday/assets/WildUtah.png',
      'Bakers for Palestine': '/ConnectUtahToday/assets/bakers_for_palestine_SLC.jpg',
      'default': '/ConnectUtahToday/assets/placeholder.jpg'
    };

    // Date utility functions
    function parseEventDate(event) {
      if (!event.date) return null;
      let date;
      if (typeof event.date === 'string') {
        date = new Date(event.date);
      } else {
        date = event.date;
      }
      if (isNaN(date.getTime())) return null;
      return date;
    }
    function getDateKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
    }
    function getWeekKey(date) {
      const startOfWeek = new Date(date);
      startOfWeek.setDate(date.getDate() - date.getDay());
      return getDateKey(startOfWeek);
    }
    function getMonthKey(date) {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
    }
    function isDateInRange(eventDate, startDate, endDate) {
      return eventDate >= startDate && eventDate <= endDate;
    }
    function getMatchingImage(summary = '', description = '') {
      const text = `${summary} ${description}`.toLowerCase();
      for (const keyword in imageMap) {
        if (keyword !== 'default' && text.includes(keyword.toLowerCase())) {
          return imageMap[keyword];
        }
      }
      return imageMap['default'];
    }
    let monthOffset = 0;
    let eventsByDate = {};
    let eventsByWeek = {};
    let eventsByMonth = {};
    let allEvents = [];

    function processAndIndexEvents(events) {
      eventsByDate = {};
      eventsByWeek = {};
      eventsByMonth = {};
      allEvents = [...events];
      events.forEach(event => {
        const eventDate = parseEventDate(event);
        if (!eventDate) return;
        const dateKey = getDateKey(eventDate);
        if (!eventsByDate[dateKey]) eventsByDate[dateKey] = [];
        eventsByDate[dateKey].push(event);
        const weekKey = getWeekKey(eventDate);
        if (!eventsByWeek[weekKey]) eventsByWeek[weekKey] = [];
        eventsByWeek[weekKey].push(event);
        const monthKey = getMonthKey(eventDate);
        if (!eventsByMonth[monthKey]) eventsByMonth[monthKey] = [];
        eventsByMonth[monthKey].push(event);
      });
    }
    function getEventsForDate(date) {
      const dateKey = getDateKey(date);
      return eventsByDate[dateKey] || [];
    }
    function getEventsForWeek(date) {
      const weekKey = getWeekKey(date);
      return eventsByWeek[weekKey] || [];
    }
    function getEventsForMonth(year, month) {
      const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
      return eventsByMonth[monthKey] || [];
    }
    function getEventsInDateRange(startDate, endDate) {
      return allEvents.filter(event => {
        const eventDate = parseEventDate(event);
        if (!eventDate) return false;
        return isDateInRange(eventDate, startDate, endDate);
      });
    }
    function getMonthRange(offset) {
      const now = new Date();
      const year = now.getFullYear();
      const month = now.getMonth() + offset;
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0, 23, 59, 59);
      return {
        startISO: start.toISOString(),
        endISO: end.toISOString(),
        label: start.toLocaleString(undefined, { month: 'long', year: 'numeric' })
      };
    }
    function updateMonthLabel(offset) {
      const range = getMonthRange(offset);
      document.getElementById('current-month-label').textContent = range.label;
    }

    // *********** LIVE RENDER ENDPOINT FOR ALL EVENTS ***********
    function fetchEventsForMonth(offset) {
      const range = getMonthRange(offset);
      // Call the live Render backend for all events
      const apiURL = `https://connectutahtoday-1.onrender.com/api/all-events?timeMin=${encodeURIComponent(range.startISO)}&timeMax=${encodeURIComponent(range.endISO)}`;
      document.getElementById('event-list').innerHTML = 'Loading events...';
      fetch(apiURL)
        .then(response => response.json())
        .then(data => {
          allEvents = data.items || [];
          processAndIndexEvents(allEvents);
          renderEvents(allEvents);
        })
        .catch(error => {
          console.error('Error fetching events:', error);
          document.getElementById('event-list').innerHTML = '<p>Error loading events.</p>';
        });
      updateMonthLabel(offset);
    }

    // Filter control handlers
    function setupFilterControls() {
      const filterTypeRadios = document.querySelectorAll('input[name="filter-type"]');
      const monthFilter = document.getElementById('month-filter');
      const weekFilter = document.getElementById('week-filter');
      const dayFilter = document.getElementById('day-filter');
      const startDateFilter = document.getElementById('start-date-filter');
      const endDateFilter = document.getElementById('end-date-filter');
      const applyButton = document.getElementById('apply-filter');
      const clearButton = document.getElementById('clear-filter');
      const now = new Date();
      monthFilter.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      filterTypeRadios.forEach(radio => {
        radio.addEventListener('change', function() {
          monthFilter.disabled = this.value !== 'month';
          weekFilter.disabled = this.value !== 'week';
          dayFilter.disabled = this.value !== 'day';
          startDateFilter.disabled = this.value !== 'range';
          endDateFilter.disabled = this.value !== 'range';
        });
      });
      applyButton.addEventListener('click', function() {
        const selectedFilter = document.querySelector('input[name="filter-type"]:checked').value;
        applyEventFilter(selectedFilter);
      });
      clearButton.addEventListener('click', function() {
        document.querySelector('input[value="all"]').checked = true;
        filterTypeRadios.forEach(radio => radio.dispatchEvent(new Event('change')));
        renderEvents(allEvents);
      });
    }
    function applyEventFilter(filterType) {
      let filteredEvents = [];
      switch(filterType) {
        case 'all':
          filteredEvents = allEvents;
          break;
        case 'month':
          const monthValue = document.getElementById('month-filter').value;
          if (monthValue) {
            const [year, month] = monthValue.split('-');
            filteredEvents = getEventsForMonth(parseInt(year), parseInt(month) - 1);
          }
          break;
        case 'week':
          const weekDate = new Date(document.getElementById('week-filter').value);
          if (!isNaN(weekDate.getTime())) {
            filteredEvents = getEventsForWeek(weekDate);
          }
          break;
        case 'day':
          const dayDate = new Date(document.getElementById('day-filter').value);
          if (!isNaN(dayDate.getTime())) {
            filteredEvents = getEventsForDate(dayDate);
          }
          break;
        case 'range':
          const startDate = new Date(document.getElementById('start-date-filter').value);
          const endDate = new Date(document.getElementById('end-date-filter').value);
          if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
            filteredEvents = getEventsInDateRange(startDate, endDate);
          }
          break;
      }
      renderEvents(filteredEvents);
    }

    // Initial fetch
    fetchEventsForMonth(monthOffset);
    document.addEventListener('DOMContentLoaded', function() {
      setupFilterControls();
      checkURLParameters();
    });
    function checkURLParameters() {
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.has('day')) {
        const dayValue = urlParams.get('day');
        document.querySelector('input[value="day"]').checked = true;
        document.getElementById('day-filter').value = dayValue;
        document.getElementById('day-filter').disabled = false;
        applyEventFilter('day');
      } else if (urlParams.has('month')) {
        const monthValue = urlParams.get('month');
        document.querySelector('input[value="month"]').checked = true;
        document.getElementById('month-filter').value = monthValue;
        document.getElementById('month-filter').disabled = false;
        applyEventFilter('month');
      } else if (urlParams.has('week')) {
        const weekValue = urlParams.get('week');
        document.querySelector('input[value="week"]').checked = true;
        document.getElementById('week-filter').value = weekValue;
        document.getElementById('week-filter').disabled = false;
        applyEventFilter('week');
      }
    }
    function renderEvents(events) {
      const container = document.getElementById('event-list');
      if (!events || events.length === 0) {
        container.innerHTML = '<p>No events found.</p>';
        return;
      }
      const googleEvents = events.filter(event => event.source === 'google');
      const mobilizeEvents = events.filter(event => event.source === 'mobilize');
      let html = '';
      if (googleEvents.length > 0) {
        html += '<ul style="list-style-type: none; padding-left: 0;">';
        googleEvents.forEach(event => {
          html += renderEventHTML(event);
        });
        html += '</ul>';
      }
      if (mobilizeEvents.length > 0) {
        html += '<ul style="list-style-type: none; padding-left: 0;">';
        mobilizeEvents.forEach(event => {
          html += renderEventHTML(event);
        });
        html += '</ul>';
      }
      container.innerHTML = html;
    }
    function renderEventHTML(event) {
      const date = event.date
        ? new Date(event.date).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })
        : 'Date TBD';
      const summary = event.summary || event.title || '';
      const description = event.description || '';
      const imageURL = event.image || getMatchingImage(summary, description);
      let eventContent = `<p style="margin-top: 18px;">${description}</p>`;
      return `
        <li style="margin-bottom: 40px; text-align: center;">
          <div style="margin-bottom: 15px;">
            <img src="${imageURL}" alt="${summary}" style="width: 100%; max-width: 400px; height: auto; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
          </div>
          <div style="text-align: left; max-width: 600px; margin: 0 auto;">
            <div style="font-size: 24px; font-weight: bold; margin-bottom: 6px;">
            ${date} â€” ${summary}</div>
            <div style="font-size: 15px; color: #444; margin-bottom: 6px;">
              <strong>Organization:</strong> ${event.org || 'Unknown'}<br>
              <strong>Type:</strong> ${event.event_type || 'Other'}
              ${event.url ? `<br><a href="${event.url}" target="_blank" style="color:#1976d2;">Event Link</a>` : ''}
            </div>
            ${eventContent}
          </div>
        </li>`;
    }
    document.getElementById('prev-month').addEventListener('click', function() {
      monthOffset--;
      fetchEventsForMonth(monthOffset);
    });
    document.getElementById('next-month').addEventListener('click', function() {
      monthOffset++;
      fetchEventsForMonth(monthOffset);
    });
    // Disclaimer popover logic
    const eventsDisclaimerLink = document.getElementById('events-disclaimer-link');
    const eventsDisclaimerPopover = document.getElementById('events-disclaimer-popover');
    const closeEventsDisclaimer = document.getElementById('close-events-disclaimer');
    eventsDisclaimerLink.addEventListener('click', function(e) {
      e.preventDefault();
      eventsDisclaimerPopover.style.display = 'block';
    });
    closeEventsDisclaimer.addEventListener('click', function() {
      eventsDisclaimerPopover.style.display = 'none';
    });
    window.addEventListener('click', function(e) {
      if (eventsDisclaimerPopover.style.display === 'block' && !eventsDisclaimerPopover.contains(e.target) && e.target !== eventsDisclaimerLink) {
        eventsDisclaimerPopover.style.display = 'none';
      }
    });
  </script>
</body>
</html>
